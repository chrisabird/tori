<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.101.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Finding similar colors &#183; トリ</title><meta name=description content><link type=text/css rel=stylesheet href=https://christopherbird.co.ukcss/print.css media=print><link type=text/css rel=stylesheet href=https://christopherbird.co.ukcss/poole.css><link type=text/css rel=stylesheet href=https://christopherbird.co.ukcss/syntax.css><link type=text/css rel=stylesheet href=https://christopherbird.co.ukcss/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body class=theme-base-0b><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://christopherbird.co.uk><h1>トリ</h1></a><p class=lead>Chris Bird</p></div><nav><ul class=sidebar-nav><li><a href=https://christopherbird.co.uk>Home</a></li></ul></nav><p>&copy; 2022. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Finding similar colors</h1><time datetime=2013-09-28T00:00:00Z class=post-date>Sat, Sep 28, 2013</time><p>Every once in a while I find a subject I get obsessed with. At the moment it&rsquo;s color, so for the next few posts I want to document some of the things I&rsquo;ve been playing with. Starting at the beginning&mldr;</p><h2 id=given-any-xy-point-in-a-picture-find-the-closest-color-from-a-limited-set>given any x,y point in a picture find the closest color from a limited set</h2><p>Introducing plastic bird, our subject of study.</p><p><img src=/img/plastic-bird.jpg alt="plastic bird" title="Fig 1"></p><p>I want to extract the color from image at position x:0 and y:0. Quick look in Gimp tells me the color is #c8a1a4. So I can write a quick bit of code to load that image our and grab the color in its <a href=https://en.wikipedia.org/wiki/SRGB>sRGB</a> component values.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>	(<span style=color:#66d9ef>defn </span>get-rgb-of-xy-in-image [x y img-path]
</span></span><span style=display:flex><span>	  (<span style=color:#66d9ef>let </span>[img (<span style=color:#a6e22e>ImageIO/read</span> (<span style=color:#a6e22e>File.</span> img-path))
</span></span><span style=display:flex><span>	        rgb (<span style=color:#a6e22e>.getRGB</span> img x y)]
</span></span><span style=display:flex><span>	   {<span style=color:#e6db74>:r</span> (bit-and (bit-shift-right rgb <span style=color:#ae81ff>16</span>) <span style=color:#ae81ff>255</span>) 
</span></span><span style=display:flex><span>	    <span style=color:#e6db74>:g</span> (bit-and (bit-shift-right rgb <span style=color:#ae81ff>8</span>) <span style=color:#ae81ff>255</span>) 
</span></span><span style=display:flex><span>	    <span style=color:#e6db74>:b</span> (bit-and rgb <span style=color:#ae81ff>255</span>)}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	(<span style=color:#a6e22e>fact</span> <span style=color:#e6db74>&#34;can get a rgb color from a xy in an image&#34;</span>
</span></span><span style=display:flex><span>		(<span style=color:#a6e22e>get-rgb-of-xy-in-image</span> <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>0</span> <span style=color:#e6db74>&#34;resources/plastic-bird.jpg&#34;</span>) =&gt; {<span style=color:#e6db74>:r</span> <span style=color:#ae81ff>200</span> <span style=color:#e6db74>:g</span> <span style=color:#ae81ff>161</span> <span style=color:#e6db74>:b</span> <span style=color:#ae81ff>164</span>})</span></span></code></pre></div><p>I now need a set of color to match again. When I was working on this problem I was presented with a set of around 2000 colors in the <a href=https://en.wikipedia.org/wiki/CIELAB>cieLab</a> color space. A little research suggest that cieLab could offer better representation of the colors and more accuracy when matching (opinions on this welcome as I can no longer find the material that informed this choice).</p><p>To do the color matching I need to take the sRGB value and convert that into the CIE master space XYZ, then into LAB (this is covered in more detail in the linked Wikipedia entry for cieLab). So first sRGB to cieXyz&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>	(<span style=color:#66d9ef>defn </span>ciexyz-adjust [component]
</span></span><span style=display:flex><span>	  (* <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>		  (<span style=color:#66d9ef>let </span>[x (/ component <span style=color:#ae81ff>255</span>)] 
</span></span><span style=display:flex><span>		   (<span style=color:#66d9ef>if </span>(&lt;= x <span style=color:#ae81ff>0.04045</span>)
</span></span><span style=display:flex><span>		     (/ x <span style=color:#ae81ff>12.92</span>)
</span></span><span style=display:flex><span>		     (<span style=color:#a6e22e>Math/pow</span> (/ (+ x <span style=color:#ae81ff>0.055</span>) <span style=color:#ae81ff>1.055</span>) <span style=color:#ae81ff>2.4</span>)))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	(<span style=color:#66d9ef>defn </span>rgb-to-ciexyz [srgb]
</span></span><span style=display:flex><span>	 (<span style=color:#66d9ef>let </span>[r (<span style=color:#a6e22e>ciexyz-adjust</span> (<span style=color:#e6db74>:r</span> srgb))
</span></span><span style=display:flex><span>		     g (<span style=color:#a6e22e>ciexyz-adjust</span> (<span style=color:#e6db74>:g</span> srgb))
</span></span><span style=display:flex><span>		     b (<span style=color:#a6e22e>ciexyz-adjust</span> (<span style=color:#e6db74>:b</span> srgb))]
</span></span><span style=display:flex><span>		 {<span style=color:#e6db74>:x</span> (float (+ (* <span style=color:#ae81ff>0.4124</span> r) (* <span style=color:#ae81ff>0.3576</span> g) (* <span style=color:#ae81ff>0.1805</span> b)))
</span></span><span style=display:flex><span>		  <span style=color:#e6db74>:y</span> (float (+ (* <span style=color:#ae81ff>0.2126</span> r) (* <span style=color:#ae81ff>0.7152</span> g) (* <span style=color:#ae81ff>0.0722</span> b)))
</span></span><span style=display:flex><span>		  <span style=color:#e6db74>:z</span> (float (+ (* <span style=color:#ae81ff>0.0193</span> r) (* <span style=color:#ae81ff>0.1192</span> g) (* <span style=color:#ae81ff>0.9505</span> b)))}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	(<span style=color:#a6e22e>fact</span> <span style=color:#e6db74>&#34;can convert sRGB to cieXyz&#34;</span>
</span></span><span style=display:flex><span>	 (<span style=color:#a6e22e>rgb-to-ciexyz</span> {<span style=color:#e6db74>:r</span> <span style=color:#ae81ff>200</span> <span style=color:#e6db74>:g</span> <span style=color:#ae81ff>161</span> <span style=color:#e6db74>:b</span> <span style=color:#ae81ff>164</span>}) =&gt; {<span style=color:#e6db74>:x</span> (float <span style=color:#ae81ff>43.265125</span>) 
</span></span><span style=display:flex><span>		                                          <span style=color:#e6db74>:y</span> (float <span style=color:#ae81ff>40.449436</span>)
</span></span><span style=display:flex><span>							  <span style=color:#e6db74>:z</span> (float <span style=color:#ae81ff>40.649162</span>)})</span></span></code></pre></div><p>See the <a href=https://en.wikipedia.org/wiki/Srgb#The_reverse_transformation>Wikipedia article on sRGB reverse transformation</a> for more details. Now on to cieXyz to cieLab&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>	(<span style=color:#66d9ef>defn </span>cielab-adjust [component]
</span></span><span style=display:flex><span>		(<span style=color:#66d9ef>if </span>(&gt; component <span style=color:#ae81ff>0.008856</span>)
</span></span><span style=display:flex><span>		 (<span style=color:#a6e22e>Math/pow</span> component (/ <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>3</span>))
</span></span><span style=display:flex><span>		 (+ (* <span style=color:#ae81ff>7.787</span> component) (<span style=color:#ae81ff>16</span> / <span style=color:#ae81ff>116</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	(<span style=color:#66d9ef>defn </span>ciexyz-to-cielab [ciexyz]
</span></span><span style=display:flex><span>	  (<span style=color:#66d9ef>let </span>[x (<span style=color:#a6e22e>cielab-adjust</span> (/ (<span style=color:#e6db74>:x</span> ciexyz) <span style=color:#ae81ff>95.047</span>))
</span></span><span style=display:flex><span>		      y (<span style=color:#a6e22e>cielab-adjust</span> (/ (<span style=color:#e6db74>:y</span> ciexyz) <span style=color:#ae81ff>100.000</span>))
</span></span><span style=display:flex><span>		      z (<span style=color:#a6e22e>cielab-adjust</span> (/ (<span style=color:#e6db74>:z</span> ciexyz) <span style=color:#ae81ff>108.883</span>))]
</span></span><span style=display:flex><span>	   {<span style=color:#e6db74>:l</span> (float (<span style=color:#66d9ef>if </span>(&gt; z <span style=color:#ae81ff>0.008856</span>) (- (* <span style=color:#ae81ff>116</span> y) <span style=color:#ae81ff>16</span>) (* <span style=color:#ae81ff>903.3</span> y)))
</span></span><span style=display:flex><span>	    <span style=color:#e6db74>:a</span> (float (* <span style=color:#ae81ff>500</span> (- x y)))
</span></span><span style=display:flex><span>	    <span style=color:#e6db74>:b</span> (float (* <span style=color:#ae81ff>200</span> (- y z)))}))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	(<span style=color:#a6e22e>fact</span> <span style=color:#e6db74>&#34;can convert CIEXYZ to CIELAB&#34;</span>
</span></span><span style=display:flex><span>		(<span style=color:#a6e22e>ciexyz-to-cielab</span> {<span style=color:#e6db74>:x</span> <span style=color:#ae81ff>43.265125</span> <span style=color:#e6db74>:y</span> <span style=color:#ae81ff>40.449436</span> <span style=color:#e6db74>:z</span> <span style=color:#ae81ff>40.649162</span>}) =&gt; {<span style=color:#e6db74>:l</span> (float <span style=color:#ae81ff>69.788445</span>) 
</span></span><span style=display:flex><span>			                                                              <span style=color:#e6db74>:a</span> (float <span style=color:#ae81ff>14.84633</span>) 
</span></span><span style=display:flex><span>				                                                            <span style=color:#e6db74>:b</span> (float <span style=color:#ae81ff>3.900725</span>)})</span></span></code></pre></div><p>See the <a href=https://en.wikipedia.org/wiki/Lab_color_space#Forward_transformation>Wikipedia article on cieLab forward transformation</a> for more details.</p><p>cieLab represents the color as a combination of its Luminocity (L) and coordinates on two positive/negative axis (A & B). &ldquo;A&rdquo; runs from green to magenta and &ldquo;B&rdquo; runs from yellow to blue. It&rsquo;s was now fairly clear that finding close colors was a problem of finding the shortest Euclidean distance between the start color and a single color in the set.</p><p>So finally I can use the following distance function to find a color from the set that has the shortest distance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>	(<span style=color:#66d9ef>defn </span>distance [x y]
</span></span><span style=display:flex><span>	(<span style=color:#a6e22e>Math/sqrt</span>
</span></span><span style=display:flex><span>	 (+ (<span style=color:#a6e22e>Math/pow</span> (- (<span style=color:#e6db74>:l</span> y) (<span style=color:#e6db74>:l</span> x)) <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	    (<span style=color:#a6e22e>Math/pow</span> (- (<span style=color:#e6db74>:a</span> y) (<span style=color:#e6db74>:a</span> x)) <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	    (<span style=color:#a6e22e>Math/pow</span> (- (<span style=color:#e6db74>:b</span> y) (<span style=color:#e6db74>:b</span> x)) <span style=color:#ae81ff>2</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	(<span style=color:#a6e22e>fact</span> <span style=color:#e6db74>&#34;can calculate euclidian distance&#34;</span>
</span></span><span style=display:flex><span>	 (<span style=color:#a6e22e>distance</span> 
</span></span><span style=display:flex><span>	   {<span style=color:#e6db74>:l</span> <span style=color:#ae81ff>67.467419</span> <span style=color:#e6db74>:a</span> <span style=color:#ae81ff>29.989378</span> <span style=color:#e6db74>:b</span> <span style=color:#ae81ff>6.301008</span>} 
</span></span><span style=display:flex><span>	   {<span style=color:#e6db74>:l</span> <span style=color:#ae81ff>42.403418</span> <span style=color:#e6db74>:a</span> <span style=color:#ae81ff>45.709176</span> <span style=color:#e6db74>:b</span> <span style=color:#ae81ff>10.237176</span>}) =&gt; <span style=color:#ae81ff>29.846433854198214</span>)</span></span></code></pre></div><p>There are problems with this though (which turned into a common realisation with color problems). The color space is not uniform, luckily there is a formula for this called Delta-E 2000. I won&rsquo;t go into the implementation but I found there to be little discernible difference in the result for the sample set of data I used. If you&rsquo;re very concerned with accuracy though this may be something worth looking into.</p><p>In future posts I&rsquo;d like to explore image quantization (reducing an image to a limited set of colors), grouping colors (given a set of colors which are red, green, etc) and finally sorting colors (taking a set of colors and putting them into aesthetically pleasing orders).</p></div></main></body></html>